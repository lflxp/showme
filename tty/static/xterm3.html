<!doctype html>
<html>
  <head>
    <title>{{ .host }}</title>
    <style>body, #terminal {position: absolute; height: 100%; width: 100%; margin: 0px;}</style>
    <link rel="stylesheet" href="/static/xterm.css" />
    <link rel="stylesheet" href="/static/fullscreen.css" />
    <script src="/static/xterm.js"></script>
    <script src="/static/fit.js"></script>
    <script src="/static/webLinks.js"></script>
    <script src="/static/search.js"></script>
    <script src="/static/fullscreen.js"></script>
    <script src="/static/base64.min.js"></script>
  </head>
  <body>
    <div id="terminal"></div>
    <script>
      const defaultTheme = {
        foreground: '#ffffff', // 字体
        background: '#1b212f', // 背景色
        cursor: '#ffffff', // 设置光标
        selection: 'rgba(255, 255, 255, 0.3)',
        black: '#000000',
        brightBlack: '#808080',
        red: '#ce2f2b',
        brightRed: '#f44a47',
        green: '#00b976',
        brightGreen: '#05d289',
        yellow: '#e0d500',
        brightYellow: '#f4f628',
        magenta: '#bd37bc',
        brightMagenta: '#d86cd8',
        blue: '#1d6fca',
        brightBlue: '#358bed',
        cyan: '#00a8cf',
        brightCyan: '#19b8dd',
        white: '#e5e5e5',
        brightWhite: '#ffffff'
      }

      const bindTerminalResize = (term, websocket) => {
        const onTermResize = size => {
          // websocket.send(
          //   JSON.stringify({
          //     type: 'resize',
          //     rows: size.rows,
          //     cols: size.cols
          //   })
          // )
          console.log('resize',size)
          websocket.send('2' + Base64.encode(size.rows + ':' + size.cols))
        }
        // register resize event.
        term.on('resize', onTermResize)
        // unregister resize event when WebSocket closed.
        websocket.addEventListener('close', function() {
          term.off('resize', onTermResize)
        })
      }

      const bindTerminal = (term, websocket, bidirectional, bufferedTime) => {
        term.socket = websocket
        let messageBuffer = null
        const handleWebSocketMessage = function(ev) {
          if (bufferedTime && bufferedTime > 0) {
            if (messageBuffer) {
              messageBuffer += ev.data
            } else {
              messageBuffer = ev.data
              setTimeout(function() {
                term.write(messageBuffer)
              }, bufferedTime)
            }
          } else {
            term.write(ev.data)
          }
        }

        const handleTerminalData = function(data) {
          // websocket.send(
          //   JSON.stringify({
          //     type: 'cmd',
          //     cmd: Base64.encode(data) // encode data as base64 format
          //   })
          // )
          websocket.send('0' + Base64.encode(data))

          // term.write(data)
        }

        websocket.onmessage = handleWebSocketMessage
        if (bidirectional) {
          term.on('data', handleTerminalData)
        }

        // send heartbeat package to avoid closing webSocket connection in some proxy environmental such as nginx.
        const heartBeatTimer = setInterval(function() {
          // websocket.send(JSON.stringify({ type: 'heartbeat', data: '' }))
          // heartbeat
          websocket.send('3')
        }, 20 * 1000)

        websocket.addEventListener('close', function() {
          websocket.removeEventListener('message', handleWebSocketMessage)
          term.off('data', handleTerminalData)
          delete term.socket
          clearInterval(heartBeatTimer)
        })
      }

      function doLink(ev, url) {
        if (ev.type === 'click') {
          window.open(url)
        }
      }

      Terminal.applyAddon(fit)
      Terminal.applyAddon(webLinks)
      Terminal.applyAddon(search)
      var term = new Terminal({
        rendererType: 'canvas', // 渲染类型
        rows: 40,
        cols: 150,
        convertEol: true, // 启用时，光标将设置为下一行的开头
        scrollback: 10, // 终端中的回滚量
        disableStdin: false, // 是否应禁用输入
        fontSize: 18,
        cursorBlink: true, // 光标闪烁
        cursorStyle: 'bar', // 光标样式 underline
        bellStyle: 'sound',
        theme: defaultTheme
      });

      function Resize() {
        term.fit()
      }

      term._initialized = true

      term.prompt = () => {
        term.write('\r\n')
      }
      
      term.writeln('Welcome to \x1B[1;3;31mhttps://github.com/lflxp/showme\x1B[0m')
      term.writeln('This is a local terminal emulation, without a real terminal in the back-end.')
      term.writeln('Type some keys and commands to play around.')
      term.prompt()

      term.on('key', function(key,ev) {
        console.log(key, ev, ev.keyCode)
      })

      term.open(document.getElementById('terminal'))
      window.addEventListener('resize', Resize)
      this.term.webLinksInit(doLink)
      term.fit()

      ws = new WebSocket('ws://' + window.location.host + '/api/ws')
      ws.onerror = () => {
        console.error('ws has no token, please login first')
      }

      ws.onclose = () => {
        term.setOption('cursorBlink', false)
        console.log('console.web_socket_disconnect')
      }

      async function test() {
        console.log('Hello')
        await sleep(1000)
        let rows = document.body.clientHeight / 18  - 5 
        let cols = document.body.clientWidth / 14
        console.log(rows,cols)
        // ws.send('2' + Base64.encode(parseInt(rows) + ':' + parseInt(cols)))
        ws.send('2' + Base64.encode(31 + ':' + 126))
        console.log('world!')
      }

      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms))
      }

      test()

      bindTerminal(term, ws, true, -1)
      bindTerminalResize(term, ws)
    </script>
  </body>
</html>